<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Master AI — Tree View</title>
  <style>
    :root{--bg:#0f1216;--panel:#121826;--muted:#96a0b8;--text:#e6edf3;--brand:#7c9cff;--brand2:#22c55e;--warn:#f59e0b;--danger:#ef4444;--border:#232b3b;--shadow:0 10px 32px rgba(0,0,0,.35)}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f15,#0f1216);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
    header{position:sticky;top:0;z-index:5;background:rgba(15,18,22,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    .brand svg{width:22px;height:22px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}
    input[type="search"],select,.btn{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}
    input[type="search"]{min-width:260px}
    .btn{cursor:pointer;display:inline-flex;gap:8px;align-items:center;box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(135deg,var(--brand),#3b82f6);border:0}
    .btn.ghost{background:transparent}
    main{max-width:1200px;margin:0 auto;padding:16px}

    /* tree */
    .tree{border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,#0f1624,#0c1320)}
    .tree-header{display:flex;gap:8px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding:10px 12px}
    .tree-body{padding:6px 8px}
    details.task{border:1px solid var(--border);border-radius:12px;background:#0e1526;margin:8px 0;overflow:hidden}
    details[open].task{background:#0e182c}
    summary{list-style:none;display:flex;gap:10px;align-items:center;padding:10px 12px;cursor:pointer}
    summary::-webkit-details-marker{display:none}
    .id{font:600 12px ui-monospace,Menlo,Consolas;color:#9fb3ff}
    .title{font-weight:600}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-left:auto}
    .chip{border:1px solid var(--border);background:#0b1120;color:var(--muted);border-radius:999px;padding:2px 8px;font-size:12px}
    .chip[ data-status="done" ]{color:#bff6c9;border-color:#1b3322;background:#0b1712}
    .chip[ data-status="blocked" ]{color:#ffd1d1;border-color:#3a1e1e;background:#1b1010}
    .chip[ data-status="in-progress" ]{color:#ffefc9;border-color:#3a2f1e;background:#1b150f}
    .chip[ data-priority="high" ]{color:#ffd2d2;border-color:#3a1d1d;background:#201216}

    .section{padding:0 12px 12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;color:#a6accd}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:8px}
    .divider{height:1px;background:var(--border);margin:10px 0}

    /* subtasks */
    .subtasks{margin-top:8px;border:1px solid var(--border);border-radius:12px;padding:8px;background:#0c1529}
    .subtasks h4{margin:0 0 6px}
    .subtask{display:flex;gap:8px;align-items:flex-start;border:1px solid var(--border);border-radius:10px;padding:8px;background:#0c1423;margin:6px 0}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.done{background:var(--brand2)}
    .dot.in-progress{background:var(--warn)}
    .dot.blocked{background:var(--danger)}
    .dot.todo{background:#3b82f6}

    /* deps */
    .deps{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .dep-box{border:1px solid var(--border);border-radius:12px;padding:8px;background:#0c1422}
    .dep-box h4{margin:0 0 6px}
    .dep-list{display:flex;flex-wrap:wrap;gap:6px}
    .dep-link{padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:#0b1120;color:#9fb3ff;text-decoration:none}

    /* json i/o modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:50}
    .modal.show{display:flex}
    .card{width:min(1000px,95vw);background:linear-gradient(180deg,#0e131c,#0b1018);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    textarea{width:100%;min-height:320px;background:#0b1018;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px;resize:vertical}

    @media (max-width: 900px){ .deps{grid-template-columns:1fr} .kv{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 2l3.09 6.26L22 9.27l-5 4.9L18.18 22 12 18.77 5.82 22 7 14.17l-5-4.9 6.91-1.01L12 2z" stroke="url(#g)" stroke-width="1.2"/><defs><linearGradient id="g" x1="0" y1="0" x2="24" y2="24"><stop stop-color="#7c9cff"/><stop offset="1" stop-color="#22c55e"/></linearGradient></defs></svg>
        <span>Task Master AI — Tree View</span>
        <span class="chip">v2</span>
      </div>
      <div class="toolbar">
        <input id="search" type="search" placeholder="Search (⌘/Ctrl+K)" />
        <select id="priorityFilter"><option value="">All priorities</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
        <select id="statusFilter"><option value="">All status</option><option value="done">Done</option><option value="in-progress">In Progress</option><option value="blocked">Blocked</option><option value="todo">To Do</option></select>
        <button class="btn" id="expandAll">Expand all</button>
        <button class="btn" id="collapseAll">Collapse all</button>
        <button class="btn primary" id="exportJson">Export JSON</button>
        <button class="btn ghost" id="importJson">Import JSON</button>
        <button class="btn ghost" id="pasteJson">Paste JSON</button>
        <input type="file" id="fileInput" accept="application/json,.json" hidden/>
      </div>
    </div>
  </header>

  <main>
    <div class="tree">
      <div class="tree-header">
        <div>
          <strong id="counter">0</strong> tasks · <span id="hpCount">0</span> high priority
        </div>
        <div class="chip">Drop a .json anywhere to import</div>
      </div>
      <div class="tree-body" id="tree"></div>
    </div>
  </main>

  <!-- Paste JSON modal -->
  <div class="modal" id="pasteModal" aria-hidden="true">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Paste tasks JSON</strong>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" id="pasteCancel">Cancel</button>
          <button class="btn primary" id="pasteApply">Apply</button>
        </div>
      </div>
      <textarea id="pasteArea" placeholder="{ &quot;master&quot;: { &quot;tasks&quot;: [...] } }" spellcheck="false"></textarea>
    </div>
  </div>

  <script>
    const q=(s,r=document)=>r.querySelector(s), qa=(s,r=document)=>Array.from(r.querySelectorAll(s));

    // Default bootstrap (can be replaced by import/paste)
    const defaultData = { master:{ tasks: [] } };
    let data = JSON.parse(localStorage.getItem('tm-ai-data')||'null') || defaultData;

    const filters={ text:'', priority:'', status:'' };

    function normalizeId(val){
      // Supports numeric IDs and dotted ids like "2.1"
      if(val==null) return null;
      const s=String(val).trim();
      return s.match(/^\d+(?:\.\d+)?$/)? s : null;
    }

    function mapTasks(){
      // Build lookup for tasks and subtasks
      const byKey=new Map();
      const parents=new Map(); // key -> parent task id
      (data.master.tasks||[]).forEach(t=>{
        const tKey=normalizeId(t.id);
        if(tKey) byKey.set(tKey,{kind:'task',ref:t});
        (t.subtasks||[]).forEach(st=>{
          const stKey=normalizeId(`${t.id}.${st.id}`);
          if(stKey){ byKey.set(stKey,{kind:'subtask',ref:st,parent:t}); parents.set(stKey,tKey); }
        });
      });
      // Build reverse dependencies
      const requiredBy=new Map();
      byKey.forEach((v,k)=> requiredBy.set(k,[]));
      (data.master.tasks||[]).forEach(t=>{
        (t.dependencies||[]).forEach(d=>{ const dk=normalizeId(d); if(dk){ if(!requiredBy.has(dk)) requiredBy.set(dk,[]); requiredBy.get(dk).push(String(t.id)); }});
        (t.subtasks||[]).forEach(st=>{
          (st.dependencies||[]).forEach(d=>{ const dk=normalizeId(d); if(dk){ if(!requiredBy.has(dk)) requiredBy.set(dk,[]); requiredBy.get(dk).push(`${t.id}.${st.id}`); }});
        });
      });
      return { byKey, parents, requiredBy };
    }

    function passesFilters(t){
      const txt = `${t.title||''} ${t.description||''} ${t.details||''}`.toLowerCase();
      if(filters.text && !txt.includes(filters.text)) return false;
      if(filters.priority && (t.priority||'').toLowerCase()!==filters.priority) return false;
      if(filters.status && (t.status||'').toLowerCase()!==filters.status) return false;
      return true;
    }

    function statusDot(s){ s=(s||'todo').toLowerCase(); return `<span class="dot ${s}"></span>`; }
    function chip(k,v){ return `<span class="chip" ${k?`data-${k}="${(v||'').toLowerCase()}"`:''}>${v}</span>`; }

    function render(){
      const tree=q('#tree'); tree.innerHTML='';
      const {byKey, requiredBy}=mapTasks();
      const tasks=(data.master.tasks||[]).filter(passesFilters);
      // counters
      q('#counter').textContent=String(tasks.length);
      q('#hpCount').textContent=String(tasks.filter(t=> (t.priority||'').toLowerCase()==='high').length);

      tasks.forEach(t=>{
        const key = normalizeId(t.id);
        const deps = (t.dependencies||[]).map(normalizeId).filter(Boolean);
        const rev = requiredBy.get(key)||[];
        const el=document.createElement('details');
        el.className='task'; el.id=`task-${key}`; el.open=false;
        el.innerHTML = `
          <summary>
            <span class="id">#${key}</span>
            <span class="title">${t.title||''}</span>
            <span class="chips">
              ${chip('status', t.status||'todo')}
              ${t.priority?chip('priority', t.priority):''}
              ${chip('', `deps ${deps.length}`)}
              ${chip('', `subtasks ${(t.subtasks||[]).length}`)}
            </span>
          </summary>
          <div class="section">
            ${t.description?`<div class="kv"><div>Description</div><div>${t.description}</div></div>`:''}
            ${t.details?`<div class="kv"><div>Details</div><div class="mono">${escapeHtml(t.details)}</div></div>`:''}
            ${t.testStrategy?`<div class="kv"><div>Test Strategy</div><div class="mono">${escapeHtml(t.testStrategy)}</div></div>`:''}
            <div class="divider"></div>
            <div class="deps">
              <div class="dep-box">
                <h4>Depends on</h4>
                <div class="dep-list">${deps.length? deps.map(d=> linkify(d)).join('') : '<span class="chip">None</span>'}</div>
              </div>
              <div class="dep-box">
                <h4>Required by</h4>
                <div class="dep-list">${rev.length? rev.map(d=> linkify(d)).join('') : '<span class="chip">—</span>'}</div>
              </div>
            </div>
            ${renderSubtasks(t, byKey)}
          </div>`;
        tree.appendChild(el);
      });
    }

    function renderSubtasks(t, byKey){
      const subs=(t.subtasks||[]).filter(passesFilters);
      if(!subs.length) return '';
      const html = subs.map(st=>{
        const key = normalizeId(`${t.id}.${st.id}`);
        const deps = (st.dependencies||[]).map(normalizeId).filter(Boolean);
        return `<div class="subtask" id="task-${key}">
          ${statusDot(st.status)}
          <div style="flex:1">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span class="id">#${key}</span>
              <strong>${st.title||''}</strong>
              ${chip('', `deps ${deps.length}`)}
            </div>
            ${st.description?`<div class="mono" style="opacity:.9;margin-top:4px">${st.description}</div>`:''}
            ${st.details?`<pre class="mono" style="white-space:pre-wrap;background:#0a1020;border:1px solid var(--border);border-radius:8px;padding:8px;margin:8px 0 0">${escapeHtml(st.details)}</pre>`:''}
            ${(deps.length)?`<div style="margin-top:6px" class="dep-list">${deps.map(d=> linkify(d)).join('')}</div>`:''}
          </div>
        </div>`;
      }).join('');
      return `<div class="subtasks"><h4>Subtasks</h4>${html}</div>`;
    }

    function linkify(key){
      return `<a class="dep-link" href="#task-${key}" data-goto="${key}">#${key}</a>`;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

    // interactions
    q('#search').addEventListener('input', e=>{ filters.text=e.target.value.toLowerCase().trim(); render(); });
    q('#priorityFilter').addEventListener('change', e=>{ filters.priority=e.target.value; render(); });
    q('#statusFilter').addEventListener('change', e=>{ filters.status=e.target.value; render(); });

    q('#expandAll').addEventListener('click', ()=> qa('details.task').forEach(d=> d.open=true));
    q('#collapseAll').addEventListener('click', ()=> qa('details.task').forEach(d=> d.open=false));

    // link scroll + focus
    document.addEventListener('click', (e)=>{
      const a=e.target.closest('[data-goto]'); if(!a) return;
      e.preventDefault();
      const id=a.getAttribute('data-goto');
      const el=q(`#task-${CSS.escape(id)}`);
      if(el){
        if(el.tagName.toLowerCase()==='details'){ el.open=true; }
        el.scrollIntoView({behavior:'smooth',block:'center'});
        el.style.boxShadow='0 0 0 2px #3b82f6 inset';
        setTimeout(()=> el.style.boxShadow='', 1200);
      }
    });

    // export / import / paste
    q('#exportJson').addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tasks.json'; a.click(); URL.revokeObjectURL(a.href);
    });
    q('#importJson').addEventListener('click', ()=> q('#fileInput').click());
    q('#fileInput').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return; try{ const text=await f.text(); applyJson(text); }catch(err){ alert('Import failed: '+err.message);} finally{ e.target.value=''; }
    });
    q('#pasteJson').addEventListener('click', ()=>{ q('#pasteArea').value=''; q('#pasteModal').classList.add('show'); });
    q('#pasteCancel').addEventListener('click', ()=> q('#pasteModal').classList.remove('show'));
    q('#pasteApply').addEventListener('click', ()=>{ try{ applyJson(q('#pasteArea').value); q('#pasteModal').classList.remove('show'); }catch(err){ alert('Invalid JSON: '+ err.message); } });

    // drag & drop anywhere
    document.addEventListener('dragover', (e)=>{ if(e.dataTransfer?.types?.includes('Files')) e.preventDefault(); });
    document.addEventListener('drop', async (e)=>{
      if(!e.dataTransfer?.files?.length) return; e.preventDefault();
      const f=[...e.dataTransfer.files].find(x=>x.type==='application/json'||x.name.endsWith('.json')); if(!f) return;
      try{ const text=await f.text(); applyJson(text); }catch(err){ alert('Import failed: '+err.message); }
    });

    function applyJson(text){
      const parsed=JSON.parse(text);
      if(!parsed.master || !Array.isArray(parsed.master.tasks)) throw new Error('Expected { master: { tasks: [...] } }');
      data=parsed; localStorage.setItem('tm-ai-data', JSON.stringify(data)); render();
    }

    // keyboard
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); q('#search').focus(); }
      if(e.key==='Escape'){ q('#pasteModal').classList.remove('show'); }
    });

    // init
    render();
  </script>
</body>
</html>
